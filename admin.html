<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üë®‚Äçüíº Admin Dashboard</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#FFD84D; color:#000; }
.wrap { max-width:900px; margin:0 auto; padding:20px; }
h1 { text-align:center; margin-bottom:10px; }
.section { background:#fff; border:1px solid #ccc; border-radius:10px; padding:16px; margin:12px 0; }
.section h2 { margin:0 0 10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px; }
.card { border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa; }
.row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.btn { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.add { background:green; color:#fff; }
.remove { background:#dc3545; color:#fff; }
.pin { background:#000; color:#fff; }
.ghost { background:#e9ecef; }
.danger { background:#dc3545; color:#fff; }
.ok { background:#000; color:#fff; }
.loginBox { text-align:center; }
.error { color:red; margin-top:10px; }
.popup { position:fixed; right:18px; bottom:18px; z-index:9999;
  background:#fff; border:1px solid #333; border-radius:10px;
  padding:12px; width:320px; box-shadow:0 8px 30px rgba(0,0,0,0.25);
}
.popup h4 { margin:0 0 8px; }
.popup .row { margin-top:8px; display:flex; gap:8px; }
input, select, textarea, button { font-size:16px; }

/* Withdraw modal */
#withdrawModal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
#withdrawModal .modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}
#withdrawModal h3 { margin-top: 0; }
#withdrawModal .modal-content {
  max-height: 70vh;
  overflow-y: auto;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>üë®‚Äçüíº Admin Dashboard</h1>

  <div id="loginBox" class="section loginBox">
    <p>Enter Admin Password:</p>
    <input type="password" id="adminPass" placeholder="Password" />
    <button class="btn ok" id="enterAdmin">Enter</button>
    <div id="errorBox" class="error"></div>
  </div>

  <div id="content" style="display:none;">
    <!-- Users Section -->
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h2>Users</h2>
        <select id="sortUsers" class="btn ghost">
          <option value="alphabet">üî§ Alphabetical (A‚ÄìZ)</option>
          <option value="newest">üóì Newest First</option>
          <option value="new">üÜï New Users (Last 7 Days)</option>
        </select>
      </div>
      <div id="userList" class="grid">Loading users...</div>
    </div>

    <!-- Pin Requests Section -->
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h2>Pin Requests</h2>
        <button class="btn danger" id="clearAllRequests">üóëÔ∏è Clear All Requests</button>
      </div>
      <div id="pinRequests">Loading requests...</div>
    </div>
  </div>
</div>

<!-- Paid notification popup -->
<div id="paidPopup" class="popup" style="display:none;">
  <h4>Payment Marked As Paid</h4>
  <div id="paidPopupBody"></div>
  <div class="row"><button class="btn ghost" id="closePaidPopup">Dismiss</button></div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal">
  <div class="modal-content">
    <h3>Pending Withdrawal</h3>
    <p id="withdrawInfo"></p>
    <div class="row" style="justify-content:center;margin-top:15px;">
      <button id="acceptWithdraw" class="btn add">Accept</button>
      <button id="rejectWithdraw" class="btn danger">Reject</button>
      <button id="closeWithdraw" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, getDoc,
  updateDoc, deleteDoc, setDoc, onSnapshot, query,
  orderBy, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBT-uB0tNUGOZGC8V2I4iP8QUXbXOHu44I",
  authDomain: "newbie-d6a5c.firebaseapp.com",
  projectId: "newbie-d6a5c",
  storageBucket: "newbie-d6a5c.firebasestorage.app",
  messagingSenderId: "931411577096",
  appId: "1:931411577096:web:8380459a4564c83ff8c4bd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ADMIN_PASSWORD = "divine45$";

const loginBox = document.getElementById("loginBox");
const errorBox = document.getElementById("errorBox");
const content = document.getElementById("content");
const userList = document.getElementById("userList");
const pinRequests = document.getElementById("pinRequests");
const sortSelect = document.getElementById("sortUsers");
const paidPopup = document.getElementById("paidPopup");
const paidPopupBody = document.getElementById("paidPopupBody");
const closePaidPopup = document.getElementById("closePaidPopup");
const withdrawModal = document.getElementById("withdrawModal");
const withdrawInfo = document.getElementById("withdrawInfo");
const acceptWithdraw = document.getElementById("acceptWithdraw");
const rejectWithdraw = document.getElementById("rejectWithdraw");
const closeWithdraw = document.getElementById("closeWithdraw");

let userSort = "alphabet";
let withdrawData = null;

function fmtDate(ts) {
  try {
    const d = ts?.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("en-US", {
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",hour12:true
    });
  } catch { return ""; }
}

document.getElementById("enterAdmin").onclick = () => {
  const pass = (document.getElementById("adminPass").value || "").trim();
  if (pass === ADMIN_PASSWORD) {
    loginBox.style.display = "none";
    content.style.display = "block";
    boot();
  } else errorBox.textContent = "‚ùå Incorrect password.";
};

// ---------- Fix missing createdAt ----------
async function fixMissingCreatedAt() {
  const snap = await getDocs(collection(db, "users"));
  const updates = [];
  snap.forEach((d) => {
    const data = d.data();
    if (!data.createdAt) updates.push(updateDoc(doc(db, "users", d.id), { createdAt: serverTimestamp() }));
  });
  if (updates.length) await Promise.all(updates);
}

// ---------- Withdraw Listener ----------
let withdrawRequests = {};
function listenForWithdraws() {
  const qW = query(collection(db, "withdrawRequests"));
  onSnapshot(qW, (snapshot) => {
    withdrawRequests = {};
    snapshot.forEach((docSnap) => {
      const w = docSnap.data();
      if (w.status === "pending") withdrawRequests[w.username] = { id: docSnap.id, ...w };
    });
    listenForUsers(); // refresh users with updated withdrawal buttons
  });
}

// ---------- Live Users ----------
function listenForUsers() {
  const qUsers = query(collection(db, "users"));
  onSnapshot(qUsers, (snapshot) => {
    userList.innerHTML = "";
    if (snapshot.empty) {
      userList.innerHTML = "<div class='card'>No users yet.</div>";
      return;
    }

    let users = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
    if (userSort === "alphabet") users.sort((a, b) => a.id.localeCompare(b.id));
    else if (userSort === "newest") users.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    else if (userSort === "new") {
      const cutoff = Date.now() / 1000 - 7 * 24 * 60 * 60;
      users = users.filter(u => (u.createdAt?.seconds || 0) > cutoff);
      users.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    }

    users.forEach((data) => {
      const name = data.id;
      const bal = data.earnings || 0;
      const pin = data.pin || "Not set";
      const created = data.createdAt ? fmtDate(data.createdAt) : "Unknown";
      const withdraw = withdrawRequests[name];

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <strong>${name}</strong><br>
        Balance: $${(bal).toLocaleString("en-US",{minimumFractionDigits:2})}<br>
        Pin: ${pin}<br>
        <small>Created: ${created}</small>
        <div class="row" style="margin-top:8px;">
          <input type="number" step="0.01" id="amt-${name}" placeholder="Amount"/>
          <button class="btn add" data-u="${name}">Add</button>
          <button class="btn remove" data-u="${name}">Remove</button>
          <button class="btn pin" data-u="${name}">Generate Pin</button>
          ${withdraw ? `<button class="btn ghost withdraw" data-u="${name}">üíµ Pending Withdrawal</button>` : ""}
        </div>`;
      userList.appendChild(card);
    });

    // Add handlers
    userList.querySelectorAll(".btn.add").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const amt = parseFloat(document.getElementById(`amt-${u}`).value);
      if (isNaN(amt)) return alert("Enter a valid amount.");
      const ref = doc(db, "users", u);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().earnings || 0) : 0;
      await updateDoc(ref, { earnings: current + amt });
      alert("Balance added ‚úÖ");
    });

    userList.querySelectorAll(".btn.remove").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const amt = parseFloat(document.getElementById(`amt-${u}`).value);
      if (isNaN(amt)) return alert("Enter a valid amount.");
      const ref = doc(db, "users", u);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().earnings || 0) : 0;
      await updateDoc(ref, { earnings: Math.max(0, current - amt) });
      alert("Balance removed ‚úÖ");
    });

    userList.querySelectorAll(".btn.pin").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const pin = Math.floor(100000 + Math.random() * 900000).toString();
      await setDoc(doc(db, "users", u), { pin }, { merge: true });
      alert(`New Pin for ${u}: ${pin}`);
    });

    userList.querySelectorAll(".btn.withdraw").forEach(btn => btn.onclick = () => {
      const u = btn.dataset.u;
      withdrawData = withdrawRequests[u];
      withdrawInfo.innerHTML = `
        <strong>User:</strong> ${withdrawData.username}<br>
        <strong>Amount:</strong> $${withdrawData.amount}<br>
        <strong>Date:</strong> ${fmtDate(withdrawData.createdAt)}
      `;
      withdrawModal.style.display = "flex";
    });
  });
}

// ---------- Withdraw Modal ----------
closeWithdraw.onclick = () => withdrawModal.style.display = "none";

acceptWithdraw.onclick = async () => {
  if (!withdrawData) return;
  await updateDoc(doc(db, "withdrawRequests", withdrawData.id), { status: "approved" });
  alert("Withdrawal approved ‚úÖ");
  withdrawModal.style.display = "none";
};

rejectWithdraw.onclick = async () => {
  if (!withdrawData) return;
  const userRef = doc(db, "users", withdrawData.username);
  const snap = await getDoc(userRef);
  const bal = snap.exists() ? (snap.data().earnings || 0) : 0;
  await updateDoc(userRef, { earnings: bal + withdrawData.amount });
  await updateDoc(doc(db, "withdrawRequests", withdrawData.id), { status: "rejected" });
  alert("Withdrawal rejected and amount reversed üîÅ");
  withdrawModal.style.display = "none";
};

// ---------- Boot ----------
async function boot() {
  await fixMissingCreatedAt();
  listenForWithdraws();
  listenForPinRequests();
  listenForPaid();
  document.getElementById("clearAllRequests").onclick = clearAllPinRequests;
  sortSelect.onchange = () => { userSort = sortSelect.value; listenForUsers(); };
}
</script>
<script type="module"> 
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, getDoc,
  updateDoc, onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBT-uB0tNUGOZGC8V2I4iP8QUXbXOHu44I",
  authDomain: "newbie-d6a5c.firebaseapp.com",
  projectId: "newbie-d6a5c",
  storageBucket: "newbie-d6a5c.firebasestorage.app",
  messagingSenderId: "931411577096",
  appId: "1:931411577096:web:8380459a4564c83ff8c4bd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ADMIN_PASSWORD = "divine45$";

const loginBox = document.getElementById("loginBox");
const errorBox = document.getElementById("errorBox");
const content = document.getElementById("content");
const userList = document.getElementById("userList");
const sortSelect = document.getElementById("sortUsers");

const withdrawModal = document.getElementById("withdrawModal");
const withdrawInfo = document.getElementById("withdrawInfo");
const acceptWithdraw = document.getElementById("acceptWithdraw");
const rejectWithdraw = document.getElementById("rejectWithdraw");
const closeWithdraw = document.getElementById("closeWithdraw");

let userSort = "alphabet";
let withdrawData = null;
let withdrawRequests = {};

function fmtDate(ts) {
  try {
    const d = ts?.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("en-US", {
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",hour12:true
    });
  } catch { return ""; }
}

document.getElementById("enterAdmin").onclick = () => {
  const pass = (document.getElementById("adminPass").value || "").trim();
  if (pass === ADMIN_PASSWORD) {
    loginBox.style.display = "none";
    content.style.display = "block";
    boot();
  } else errorBox.textContent = "‚ùå Incorrect password.";
};

// Fix missing createdAt
async function fixMissingCreatedAt() {
  const snap = await getDocs(collection(db, "users"));
  const updates = [];
  snap.forEach((d) => {
    const data = d.data();
    if (!data.createdAt) updates.push(updateDoc(doc(db, "users", d.id), { createdAt: serverTimestamp() }));
  });
  if (updates.length) await Promise.all(updates);
}

// Listen for withdraw requests
function listenForWithdraws() {
  const qW = query(collection(db, "withdrawRequests"));
  onSnapshot(qW, (snapshot) => {
    withdrawRequests = {};
    snapshot.forEach(docSnap => {
      const w = docSnap.data();
      if (w.status === "pending") withdrawRequests[w.username] = { id: docSnap.id, ...w };
    });
    listenForUsers(); // refresh user cards
  });
}

// Listen for users and show withdraw buttons
function listenForUsers() {
  const qUsers = query(collection(db, "users"));
  onSnapshot(qUsers, (snapshot) => {
    userList.innerHTML = "";
    if (snapshot.empty) {
      userList.innerHTML = "<div class='card'>No users yet.</div>";
      return;
    }

    let users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

    // Sort
    if (userSort === "alphabet") users.sort((a,b) => a.id.localeCompare(b.id));
    else if (userSort === "newest") users.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    else if (userSort === "new") {
      const cutoff = Date.now()/1000 - 7*24*60*60;
      users = users.filter(u => (u.createdAt?.seconds||0) > cutoff);
      users.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    }

    users.forEach(data => {
      const name = data.id;
      const bal = data.earnings || 0;
      const pin = data.pin || "Not set";
      const created = data.createdAt ? fmtDate(data.createdAt) : "Unknown";
      const withdraw = withdrawRequests[name];

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <strong>${name}</strong><br>
        Balance: $${bal.toLocaleString("en-US",{minimumFractionDigits:2})}<br>
        Pin: ${pin}<br>
        <small>Created: ${created}</small>
        <div class="row" style="margin-top:8px;">
          <input type="number" step="0.01" id="amt-${name}" placeholder="Amount"/>
          <button class="btn add" data-u="${name}">Add</button>
          <button class="btn remove" data-u="${name}">Remove</button>
          <button class="btn pin" data-u="${name}">Generate Pin</button>
        </div>`;
      userList.appendChild(card);

      // Add withdraw button
      if (withdraw) {
        const btn = document.createElement("button");
        btn.className = "btn ghost withdraw";
        btn.textContent = "üíµ Pending Withdrawal";
        btn.dataset.u = name;
        btn.onclick = () => {
          withdrawData = withdrawRequests[name];
          withdrawInfo.innerHTML = `
            <strong>User:</strong> ${withdrawData.username}<br>
            <strong>Amount:</strong> $${withdrawData.amount}<br>
            <strong>Date:</strong> ${fmtDate(withdrawData.createdAt)}
          `;
          withdrawModal.style.display = "flex";
        };
        card.querySelector(".row").appendChild(btn);
      }
    });

    // Add handlers for add/remove/pin
    userList.querySelectorAll(".btn.add").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const amt = parseFloat(document.getElementById(`amt-${u}`).value);
      if (isNaN(amt)) return alert("Enter a valid amount.");
      const ref = doc(db, "users", u);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().earnings || 0) : 0;
      await updateDoc(ref, { earnings: current + amt });
      alert("Balance added ‚úÖ");
    });

    userList.querySelectorAll(".btn.remove").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const amt = parseFloat(document.getElementById(`amt-${u}`).value);
      if (isNaN(amt)) return alert("Enter a valid amount.");
      const ref = doc(db, "users", u);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().earnings || 0) : 0;
      await updateDoc(ref, { earnings: Math.max(0, current - amt) });
      alert("Balance removed ‚úÖ");
    });

    userList.querySelectorAll(".btn.pin").forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.u;
      const pin = Math.floor(100000 + Math.random() * 900000).toString();
      await updateDoc(doc(db, "users", u), { pin });
      alert(`New Pin for ${u}: ${pin}`);
    });
  });
}

// Withdraw modal buttons
closeWithdraw.onclick = () => withdrawModal.style.display = "none";

acceptWithdraw.onclick = async () => {
  if (!withdrawData) return;
  await updateDoc(doc(db, "withdrawRequests", withdrawData.id), { status: "approved" });
  alert("Withdrawal approved ‚úÖ");
  withdrawModal.style.display = "none";
};

rejectWithdraw.onclick = async () => {
  if (!withdrawData) return;
  const userRef = doc(db, "users", withdrawData.username);
  const snap = await getDoc(userRef);
  const bal = snap.exists() ? (snap.data().earnings || 0) : 0;
  await updateDoc(userRef, { earnings: bal + withdrawData.amount });
  await updateDoc(doc(db, "withdrawRequests", withdrawData.id), { status: "rejected" });
  alert("Withdrawal rejected üîÅ");
  withdrawModal.style.display = "none";
};

// Boot
async function boot() {
  await fixMissingCreatedAt();
  listenForWithdraws();
  sortSelect.onchange = () => { userSort = sortSelect.value; listenForUsers(); };
}
</script>
</body>
</html>